/*
 * producer_consumer.c
 *
 *  Created on: Aug 10, 2017
 *      Author: Jaan Horng
 */

#include "stm32f1xx_hal.h"
#include "cmsis_os.h"

extern osThreadId defaultTaskHandle;
osThreadId task01Handle;
osThreadId task02Handle;
osMessageQId itemQueueHandle;
osMutexId queueMutHandle;
osSemaphoreId slotSemHandle;
osSemaphoreId itemSemHandle;

void produce(uint8_t value){
	xSemaphoreTake(slotSemHandle, portMAX_DELAY);

    osMutexWait(queueMutHandle, portMAX_DELAY);
    osMessagePut(itemQueueHandle, value, 1000);
	osMutexRelease(queueMutHandle);

	xSemaphoreGive(itemSemHandle);
}

uint8_t consume(){
	xSemaphoreTake(itemSemHandle, portMAX_DELAY);

	osMutexWait(queueMutHandle, portMAX_DELAY);
	osMessageGet(itemQueueHandle, 500);
	osMutexRelease(queueMutHandle);

	xSemaphoreGive(slotSemHandle);
}
